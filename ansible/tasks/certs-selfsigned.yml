---
- name: Checking SLATE cert directory
  stat:
    path: "/etc/ssl/{{ slate_hostname }}"
  register: slate_cert_directory

- name: Creating SLATE cert directory
  file:
    path: "/etc/ssl/{{ slate_hostname }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  when: slate_cert_directory.stat.exists == false

- name: Create key pair for the server
  openssl_privatekey:
    path: "{{ slate_certificate.key_file }}"
    size: 2048

- name: Create certificate signing request
  openssl_csr:
    common_name: "slate_portal"
    country_name: "US"
    email_address: "slate@slateci.io"
    locality_name: "Salt Lake City"
    organization_name: "University of Utah"
    path: "{{ slate_certificate.chain_file }}"
    subject_alt_name:
      - "DNS:*.{{ slate_hostname }}"
      - "DNS:{{ slate_hostname }}"
    privatekey_path: "{{ slate_certificate.key_file }}"

- name: Create self-signed certificate
  openssl_certificate:
    csr_path: "{{ slate_certificate.chain_file }}"
    path: "{{ slate_certificate.file }}"
    provider: selfsigned
    privatekey_path: "{{ slate_certificate.key_file }}"
